"use strict";!function(e){e.runtime.sendMessage({cmd:"track_page_view",path:"/facebook-messenger-history.html"}),e.cookies.get({url:"https://*.facebook.com",name:"c_user"},function(n){if(null===n){if("notifications"in e){var t=e.extension.getURL("images/juno_okyo.png");e.notifications.create({type:"basic",iconUrl:t,title:e.i18n.getMessage("appName"),message:e.i18n.getMessage("error")+": "+e.i18n.getMessage("facebookLoginError")+"."})}window.top.location.replace("https://www.facebook.com/login")}else new Vue({el:"#main",data:{loading:!1,error:!1,url:null,mid:null,r:Date.now(),l:new Date("1/1/2004").getTime(),result:null,results:null,csrf_token:null,access_token:null,endpoint:"https://www.facebook.com/api/graphqlbatch/",my_info:{id:n.value,name:"Me",avatar:null},friend_info:{id:null,name:"Unknow",avatar:null},show_load_more:!0,loading_more:!1,is_premium_user:!1},methods:{formatTime:function(e){return dateFns.format(parseInt(e),"h:m A, DD/MM/YYYY")},startScan:function(){var n=this;this.result=null,this.mid=null,this.r=Date.now(),this.l=new Date("1/1/2004").getTime(),this.show_load_more=!0,this.isFacebookUrl()&&(this.loading=!0,this.error=!1,fetch("https://graph.facebook.com/"+encodeURIComponent(this.getUsername(this.url))+"?fields=id&access_token="+this.access_token).then(function(e){return e.json()}).then(function(t){t.id&&(n.friend_info.id=t.id,n.getUserInfo(n.friend_info.id).then(function(t){t.id&&t.name&&(n.friend_info.name=t.name,n.friend_info.avatar=t.picture.data.url),null!==n.friend_info.id&&n.friend_info.id.length>0&&e.runtime.sendMessage({cmd:"update_fb_origin",enable:!0},function(t){if(t.success){var r=n.is_premium_user?50:15;n.search(1).then(function(e){try{return n.getMessagesAfter(e[0].message_id,r)}catch(t){console.error(t.message)}}).then(function(t){n.result=n.result.concat(t),n.loading=!1,e.runtime.sendMessage({cmd:"update_fb_origin",enable:!1})})}})}))}))},makeQuery:function(e,n){return{o0:{doc_id:"1526314457427586",query_params:{id:this.friend_info.id,message_limit:n,load_messages:1,load_read_receipts:!0,before:e}}}},isExist:function(e,n){var t=this;return new Promise(function(r){fetch(t.endpoint,{headers:{"Content-Type":"application/x-www-form-urlencoded"},method:"POST",body:"fb_dtsg="+t.csrf_token+"&queries="+JSON.stringify(t.makeQuery(e,n)),credentials:"include"}).then(function(e){return e.text()}).then(function(e){var n=JSON.parse(e.split("\n")[0]);try{null===n.o0.data.message_thread?(t.error=!0,t.loading=!1):r(n.o0.data.message_thread.messages.nodes)}catch(i){console.error(i.message),t.error=!0,t.loading=!1}})})},search:function(e){var n=this;return new Promise(function(t){Math.abs(n.l-n.r)<=1e3?(n.loading=!1,null===n.result?n.error=!0:(n.error=!1,t(n.result))):(n.mid=1e3*Math.round((n.l+n.r)/2/1e3),n.isExist(n.mid,e).then(function(r){r.length===e?(n.r=n.mid-1,n.result=r):n.l=n.mid+1,n.search(e).then(t)}))})},getMessagesAfter:function(e,n){var t=this;return new Promise(function(r,i){fetch("https://www.facebook.com/ajax/mercury/search_context.php",{headers:{"Content-Type":"application/x-www-form-urlencoded"},method:"POST",body:"message_id="+e+"&limit="+n+"&direction=down&other_user_fbid="+t.friend_info.id+"&__a=1&fb_dtsg="+t.csrf_token,credentials:"include"}).then(function(e){return e.text()}).then(function(e){var n=JSON.parse(e.substr(9)),t=n.payload.graphql_payload;if(t)r(t);else{var o=new Error("There is no results.");i(o)}})})},getName:function(e){return e==this.my_info.id?this.my_info.name:this.friend_info.name},getAvatar:function(e){return e==this.my_info.id?this.my_info.avatar:this.friend_info.avatar},isMyMessage:function(e){return e==this.my_info.id},isFacebookUrl:function(){try{return new URL(this.url).hostname.includes(".facebook.com")}catch(e){return console.error(e.message),!1}},getUsername:function(e){try{var n=new URL(e),t=n.pathname.substr(1);t.includes("/")&&(t=t.split("/")[0]);var r="profile.php"===t?n.searchParams.get("id"):t;return!r.includes("/")&&r}catch(i){return console.error(i.message),!1}},loadMoreMessages:function(){var n=this;if(null===this.result)this.show_load_more=!1;else{var t=this.result[this.result.length-1].message_id;this.loading_more=!0,e.runtime.sendMessage({cmd:"update_fb_origin",enable:!0},function(r){n.getMessagesAfter(t,41).then(function(r){r[0].message_id===t&&r.shift(),n.result=n.result.concat(r),n.loading_more=!1,e.runtime.sendMessage({cmd:"update_fb_origin",enable:!1})})["catch"](function(t){n.show_load_more=!1,n.loading_more=!1,e.runtime.sendMessage({cmd:"update_fb_origin",enable:!1})})})}},getUserInfo:function(e){var n="https://graph.facebook.com/"+encodeURIComponent(e)+"/?fields=name,picture&access_token="+this.access_token;return fetch(n).then(function(e){return e.json()})}},mounted:function(){var n=this;e.runtime.onMessage.addListener(function(t,r,i){if("facebook_authentication_response"===t.cmd.toLowerCase()&&t.data&&t.user){n.csrf_token=t.user.csrf_token,n.access_token=t.data,n.loading=!1,n.getUserInfo(t.user.id).then(function(t){t.id&&t.name?(n.my_info.name=t.name,n.my_info.avatar=t.picture.data.url):e.storage.local.set({user_cert:null},function(){})})["catch"](function(e){console.error(e.message)});var o=new URL(window.top.location.href),s=o.searchParams.get("id");null!==s&&(n.url="https://www.facebook.com/profile.php?id="+s,n.startScan())}}),this.loading=!0,e.runtime.sendMessage({cmd:"facebook_authentication"}),e.storage.sync.get({account_type:"free"},function(e){n.is_premium_user="premium"===e.account_type})},updated:function(){try{jQuery("video, audio").mediaelementplayer()}catch(e){}}})})}(chrome);